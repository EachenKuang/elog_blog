---
password: ""
icon: ""
date: "2021-09-16"
type: Post
category: æŠ€æœ¯åˆ†äº«
slug: redis-usding-pipeline-speed-up
tags:
  - Redis
  - å¼€å‘
summary: Redisæ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œå®ƒå¯ä»¥å¿«é€Ÿåœ°å­˜å‚¨å’Œæ£€ç´¢æ•°æ®ã€‚ä½†æ˜¯ï¼Œå½“éœ€è¦æ‰§è¡Œå¤§é‡çš„RedisæŸ¥è¯¢æ—¶ï¼Œæ¯ä¸ªæŸ¥è¯¢éƒ½éœ€è¦ä¸RedisæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisæä¾›äº†Pipelineæœºåˆ¶ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªæŸ¥è¯¢æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä¸€æ¬¡æ€§å‘é€ç»™RedisæœåŠ¡å™¨ï¼Œä»è€Œæé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Redis Pipelineæœºåˆ¶æ¥æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå¹¶æ¢è®¨Pipelineæœºåˆ¶çš„å·¥ä½œåŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚
title: Redisä½¿ç”¨Pipelineæé«˜æŸ¥è¯¢é€Ÿåº¦
status: Published
cover: "https://images.unsplash.com/photo-1605600659873-d808a13e4d2a?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb"
urlname: c3e54c4b-ad14-484c-aeac-de9296dc24e6
updated: "2023-08-06 16:48:00"
---

> ğŸ˜€ Redis æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œå®ƒå¯ä»¥å¿«é€Ÿåœ°å­˜å‚¨å’Œæ£€ç´¢æ•°æ®ã€‚ä½†æ˜¯ï¼Œå½“éœ€è¦æ‰§è¡Œå¤§é‡çš„ Redis æŸ¥è¯¢æ—¶ï¼Œæ¯ä¸ªæŸ¥è¯¢éƒ½éœ€è¦ä¸ Redis æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº† Pipeline æœºåˆ¶ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªæŸ¥è¯¢æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä¸€æ¬¡æ€§å‘é€ç»™ Redis æœåŠ¡å™¨ï¼Œä»è€Œæé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Redis Pipeline æœºåˆ¶æ¥æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå¹¶æ¢è®¨ Pipeline æœºåˆ¶çš„å·¥ä½œåŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚

# ğŸ“ ä¸»æ—¨å†…å®¹

## **ä»€ä¹ˆæ˜¯ RTT (Round Trip Time å¾€è¿”æ—¶é—´)ï¼Ÿ**

åœ¨ç»´åŸºç™¾ç§‘ä¸­ï¼Œæ˜¯è¿™æ ·[**ä»‹ç»**](https://en.wikipedia.org/wiki/Round-trip_delay)çš„ï¼š

åœ¨ç”µè®¯æ–¹é¢ï¼Œ **round-trip delay** (**RTD**) æˆ– **round-trip time** (**RTT**) æ˜¯æŒ‡å‘é€ä¿¡å·æ‰€éœ€çš„æ—¶é—´ï¼ŒåŠ ä¸Šç¡®è®¤æ¥æ”¶ä¿¡å·æ‰€éœ€çš„æ—¶é—´ã€‚æ­¤æ—¶é—´åŒ…æ‹¬ä¸¤ä¸ªé€šä¿¡ç«¯ç‚¹ä¹‹é—´çš„è·¯å¾„çš„ä¼ æ’­æ—¶é—´ã€‚åœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œä¿¡å·é€šå¸¸æ˜¯ä¸€ä¸ªæ•°æ®åŒ…ã€‚RTT ä¹Ÿç§°ä¸º ping æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡ ping å‘½ä»¤ç¡®å®šã€‚

å¯ä»¥è¿™æ ·ç†è§£ï¼Œä»å®¢æˆ·ç«¯å‘é€ä¿¡å·å¼€å§‹ï¼Œåˆ°æœåŠ¡ç«¯æ¥å—ä¿¡å·åï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„ä¿¡å·è¿™ä¸€è¿‡ç¨‹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚

## **ä»€ä¹ˆæ˜¯ Redis ä¸­çš„ Pipelining?**

å¯¹äºåŸºäº Request/Response çš„æœåŠ¡å™¨å¯ä»¥è¢«å®ç°æˆå¤„ç†æ–°çš„è¯·æ±‚ï¼Œå³ä½¿å®¢æˆ·ç«¯è¿˜æ²¡æ”¶åˆ°æ—§çš„å“åº”ã€‚è¿™æ ·å°±å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªå‘½ä»¤ç»™æœåŠ¡å™¨è€Œä¸ç”¨ç­‰å¾…å“åº”ï¼Œæœ€åç»Ÿä¸€è¯»å›å¤šä¸ªè¿”å›ã€‚

è¿™ç§æ–¹å¼è¢«å«åš pipelining, æ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨å¤šå¹´çš„æŠ€æœ¯ï¼Œæ‰¹é‡å‘é€ï¼Œæ‰¹é‡è¿”å›ã€‚ä¾‹å¦‚ POP3 åè®®ä¹Ÿæ˜¯è¿™æ ·ï¼Œæ¥åŠ é€Ÿä»æœåŠ¡å™¨ä¸Šä¸‹è½½é‚®ä»¶ã€‚

## **ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Pipeline æé«˜ Redis æŸ¥è¯¢é€Ÿåº¦ï¼Ÿ**

Redis åœ¨æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´ä¼ è¾“ä¿¡å·æ˜¯å­˜åœ¨ç½‘ç»œå»¶æ—¶çš„ï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯ RTTã€‚

è¯•æƒ³ï¼Œå¦‚æœç®—ä¸Š RTT çš„ç½‘ç»œå»¶è¿Ÿå½±å“ï¼Œå¦‚æœå®¢æˆ·ç«¯éœ€è¦è¿ç»­å‘é€å¤šä¸ªè¯·æ±‚çš„æƒ…å†µä¸‹ï¼ŒRTT å¯¹æ€§èƒ½çš„å½±å“æ˜¯å¾ˆä¸¥é‡çš„ã€‚å‡å¦‚ RTT çš„ç½‘ç»œå»¶æ—¶æ˜¯ 250msï¼Œå°½ç®¡ Redis æœåŠ¡ç«¯æ¯ç§’èƒ½å¤„ç† 10 ä¸‡ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿåªèƒ½æ¯ç§’æœ€å¤šå¤„ç†å››ä¸ªè¯·æ±‚ã€‚

å¦‚æœèƒ½å¤Ÿå°†è¿™é‡Œè¯·æ±‚ä¸€å¹¶ä¼ ç»™æœåŠ¡ç«¯å¤„ç†ï¼Œé‚£ä¹ˆä¹…ä¸éœ€è¦æ¯æ¬¡éƒ½å› ä¸ºå»¶æ—¶å½±å“ä¼ è¾“æŸ¥è¯¢æ•ˆç‡äº†ã€‚

æ‰€ä»¥ï¼Œå¯¹äºå¤§é‡çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Pipeline æ¥ä¸€æ¬¡æ€§ä¼ è¾“è¯·æ±‚å‘½ä»¤ï¼Œæœ€åç»Ÿä¸€è¯»å›æ•°æ®ã€‚

> ğŸ’¡ ç‰¹åˆ«æ³¨æ„: å½“å®¢æˆ·ç«¯ä½¿ç”¨ç®¡é“ pipelining å‘é€å‘½ä»¤æ—¶ï¼ŒæœåŠ¡å™¨ç«¯éœ€è¦æ¶ˆè€—å†…å­˜æ¥å­˜æ”¾å“åº”ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦å‘é€å¤§é‡çš„å‘½ä»¤ï¼Œæœ€å¥½åˆ†æ‰¹å‘é€ï¼Œä¾‹å¦‚ä¸€æ¬¡å‘é€ 1 ä¸‡ä¸ªï¼Œè¯»å–å›æŠ¥ï¼Œå†å¾ªç¯å‘å‰©ä½™çš„å‘½ä»¤ã€‚é€Ÿåº¦ä¸Šå‡ ä¹æ— å·®å¼‚ï¼Œä½†æ˜¯å†…å­˜æœ€å¤§æ¶ˆè€— 1 ä¸‡ä¸ªå‘½ä»¤å›å¤ç»“æœçš„å†…å­˜ã€‚

## **åŸºå‡†æµ‹è¯•**

ä½¿ç”¨ Python-Redis è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ç»“æœå·®å¼‚è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚

```python
Â # benchmark.py
Â 
Â from redis_ins.client import Client
Â from redis_ins.time_decorator import run_time
Â 
Â loop_round = 1000
Â 
Â 
Â @run_time
Â def with_pipeline(client: Client):
Â  Â  Â pipeline = client.instance.pipeline()
Â  Â  Â for i in range(loop_round):
Â  Â  Â  Â  Â pipeline.ping()
Â  Â  Â pipeline.execute()
Â 
Â 
Â @run_time
Â def without_pipeline(client: Client):
Â  Â  Â for i in range(loop_round):
Â  Â  Â  Â  Â client.instance.ping()
Â 
Â 
Â if __name__ == '__main__':
Â  Â  Â client = Client()
Â  Â  Â print("with pipeline")
Â  Â  Â with_pipeline(client)
Â  Â  Â print("without pipeline")
Â  Â  Â without_pipeline(client)

```

å¾ªç¯ 1000 æ¬¡çš„è€—æ—¶å¯¹æ¯”

```text
Â with pipeline
Â å‡½æ•°with_pipelineè¿è¡Œå¼€å§‹:1631769580.494915
Â å‡½æ•°with_pipelineè¿è¡Œç»“æŸ:1631769580.573953
Â å‡½æ•°with_pipelineæ‰§è¡Œäº†0.079ç§’
Â without pipeline
Â å‡½æ•°without_pipelineè¿è¡Œå¼€å§‹:1631769580.5739899
Â å‡½æ•°without_pipelineè¿è¡Œç»“æŸ:1631769591.982709
Â å‡½æ•°without_pipelineæ‰§è¡Œäº†11.4087ç§’
```

å¾ªç¯ 10000 æ¬¡çš„è€—æ—¶å¯¹æ¯”

```text
Â with pipeline
Â å‡½æ•°with_pipelineè¿è¡Œå¼€å§‹:1631769352.6500359
Â å‡½æ•°with_pipelineè¿è¡Œç»“æŸ:1631769352.873387
Â å‡½æ•°with_pipelineæ‰§è¡Œäº†0.2234ç§’
Â without pipeline
Â å‡½æ•°without_pipelineè¿è¡Œå¼€å§‹:1631769352.873431
Â å‡½æ•°without_pipelineè¿è¡Œç»“æŸ:1631769461.964499
Â å‡½æ•°without_pipelineæ‰§è¡Œäº†109.0911ç§’
```

|                 | 1000 æ¬¡å¾ªç¯ | 10000 æ¬¡å¾ªç¯ |
| --------------- | ----------- | ------------ |
| ä½¿ç”¨ pipeline   | 0.079 ç§’    | 0.2234 ç§’    |
| ä¸ä½¿ç”¨ pipeline | 11.4087 ç§’  | 109.0911 ç§’  |

# ğŸ¤— æ€»ç»“å½’çº³

å¯ä»¥çœ‹å‡ºï¼Œåœ¨ Redis ä¸­ï¼ŒRedis æä¾›äº† Pipeline æœºåˆ¶ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªæŸ¥è¯¢æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä¸€æ¬¡æ€§å‘é€ç»™ Redis æœåŠ¡å™¨ï¼Œä»è€Œæé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚

# ğŸ“ å‚è€ƒæ–‡ç« 

- [**Using pipelining to speedup Redis queries â€“ Redis**](https://redis.io/topics/pipelining)
