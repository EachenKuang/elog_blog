---
password: ""
icon: ""
date: "2024-12-20"
type: Post
category: æŠ€æœ¯åˆ†äº«
slug: certbot-auto-renew
tags:
  - å»ºç«™
  - å·¥å…·
summary: ""
title: ä½¿ç”¨ Certbot å®ç°è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
status: Published
urlname: 16254ee3-2891-80df-af79-dce76d77fc2f
updated: "2024-12-20 11:00:00"
---

> ğŸ˜€ åœ¨ç½‘ç»œå®‰å…¨æ—¥ç›Šé‡è¦çš„ä»Šå¤©ï¼ŒSSL/TLS è¯ä¹¦å¯¹äºç¡®ä¿ç½‘ç«™çš„å®‰å…¨æ€§å’Œå¯ä¿¡åº¦èµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚Let's Encrypt æ˜¯ä¸€ä¸ªå…è´¹ã€è‡ªåŠ¨åŒ–å’Œå¼€æ”¾çš„è¯ä¹¦é¢å‘æœºæ„ï¼Œä¸ºå¹¿å¤§ç½‘ç«™æ‰€æœ‰è€…æä¾›äº†å…è´¹çš„ SSL/TLS è¯ä¹¦ï¼Œæå¤§åœ°æ¨åŠ¨äº†äº’è”ç½‘çš„å®‰å…¨å‘å±•ã€‚  
> ç„¶è€Œï¼ŒLet's Encrypt é¢å‘çš„å…è´¹è¯ä¹¦çš„æœ‰æ•ˆæœŸæ›¾ç»ä¸º 90 å¤©ï¼Œç°åœ¨ç¼©çŸ­ä¸º 3 ä¸ªæœˆã€‚è¿™æ ·çš„çŸ­æœ‰æ•ˆæœŸæ˜¯ä¸ºäº†ç¡®ä¿è¯ä¹¦çš„å®‰å…¨æ€§å’Œæœ‰æ•ˆæ€§ï¼ŒåŠæ—¶æ›´æ–°å¯èƒ½å‡ºç°çš„å®‰å…¨æ¼æ´å’Œé—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿé¼“åŠ±è¯ä¹¦ä½¿ç”¨è€…ä¿æŒå¯¹è¯ä¹¦ç®¡ç†çš„å…³æ³¨å’Œç»´æŠ¤ã€‚ä½†å¯¹äºç½‘ç«™æ‰€æœ‰è€…æ¥è¯´ï¼Œæ‰‹åŠ¨æ¯ä¸‰ä¸ªæœˆæ›´æ–°ä¸€æ¬¡è¯ä¹¦æ˜¯ä¸€é¡¹ç¹çä¸”å®¹æ˜“è¢«é—å¿˜çš„ä»»åŠ¡ã€‚å¦‚æœè¯ä¹¦è¿‡æœŸæœªåŠæ—¶æ›´æ–°ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç½‘ç«™å‡ºç°å®‰å…¨è­¦å‘Šï¼Œå½±å“ç”¨æˆ·ä¿¡ä»»åº¦å’Œè®¿é—®ä½“éªŒã€‚å› æ­¤ï¼Œå®ç°è¯ä¹¦çš„è‡ªåŠ¨ç»­æœŸå°±å˜å¾—å°¤ä¸ºé‡è¦ã€‚

# ä¸€ã€å®‰è£…æ­¥éª¤

## **1.1 å®‰è£… Certbot**

1. åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šå®‰è£… Certbot çš„æ–¹æ³•ä¼šæœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§æ“ä½œç³»ç»Ÿçš„å®‰è£…æ–¹æ³•ï¼š

- **Ubuntu/Debian**ï¼š

```shell
sudo apt-get updatesudo apt-get install certbot
```

- **CentOS/RHEL**ï¼š

```shell
sudo yum install epel-releasesudo yum install certbot
```

2. å®‰è£…å®Œæˆåï¼Œå¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥ Certbot æ˜¯å¦å®‰è£…æˆåŠŸï¼š

```shell
certbot --version
```

å¦‚æœæ˜¯å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œå¯ä»¥æŸ¥çœ‹ï¼šÂ [https://certbot.eff.org/instructions](https://certbot.eff.org/instructions)

## **1.2 è·å–è¯ä¹¦**

1. ä½¿ç”¨ Certbot è·å–è¯ä¹¦çš„å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š

```shell
certbot certonly --nginx -d example.com -d www.example.com
```

- -nginxï¼šè¡¨ç¤ºä½¿ç”¨ Nginx æ’ä»¶æ¥é…ç½®è¯ä¹¦ã€‚å¦‚æœä½ çš„ Web æœåŠ¡å™¨æ˜¯å…¶ä»–ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ç›¸åº”çš„æ’ä»¶ï¼Œå¦‚--apache ç­‰ã€‚
- dÂ [example.com](http://example.com/)Â -dÂ [www.example.com](http://www.example.com/)ï¼šæŒ‡å®šè¦ä¸ºå“ªäº›åŸŸåè·å–è¯ä¹¦ã€‚å¯ä»¥æŒ‡å®šå¤šä¸ªåŸŸåï¼Œç”¨ç©ºæ ¼éš”å¼€ã€‚

1. è¿è¡Œå‘½ä»¤åï¼ŒCertbot ä¼šå¼•å¯¼ä½ è¿›è¡Œä¸€äº›é…ç½®ï¼Œä¾‹å¦‚åŒæ„æœåŠ¡æ¡æ¬¾ã€è®¾ç½®é‚®ç®±ç­‰ã€‚æŒ‰ç…§æç¤ºå®Œæˆæ“ä½œåï¼ŒCertbot ä¼šä¸ºæŒ‡å®šçš„åŸŸåç”Ÿæˆè¯ä¹¦ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ç›¸åº”çš„ä½ç½®ã€‚

## **1.3 é…ç½®è‡ªåŠ¨ç»­æœŸ**

1. Certbot å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡æ¥å®ç°è¯ä¹¦çš„è‡ªåŠ¨ç»­æœŸã€‚åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨ cron æ¥è®¾ç½®å®šæ—¶ä»»åŠ¡ã€‚
2. æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥ç¼–è¾‘ cron ä»»åŠ¡ï¼š

```shell
crontab -e
```

1. åœ¨æ‰“å¼€çš„æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```shell
0 0,12 * * * /usr/bin/certbot renew --quiet && service nginx reload
```

> ğŸ’¡ è¯´æ˜
>
> - 0 0,12 \* \* \*ï¼šè¡¨ç¤ºæ¯å¤©çš„ 0 ç‚¹å’Œ 12 ç‚¹æ‰§è¡Œä»»åŠ¡ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è°ƒæ•´è¿™ä¸ªæ—¶é—´ã€‚
> - /usr/bin/certbot renew --quietï¼šæ‰§è¡Œ Certbot çš„ç»­æœŸå‘½ä»¤ï¼Œ--quiet å‚æ•°è¡¨ç¤ºé™é»˜æ¨¡å¼ï¼Œä¸è¾“å‡ºè¿‡å¤šçš„ä¿¡æ¯ã€‚
> - service nginx reloadï¼šå¦‚æœä½ çš„ Web æœåŠ¡å™¨æ˜¯ Nginxï¼Œåœ¨ç»­æœŸå®Œæˆåé‡æ–°åŠ è½½ Nginx æœåŠ¡ï¼Œä½¿æ–°çš„è¯ä¹¦ç”Ÿæ•ˆã€‚å¦‚æœä½ çš„ Web æœåŠ¡å™¨æ˜¯å…¶ä»–ç±»å‹ï¼Œå°†æ­¤å‘½ä»¤æ›¿æ¢ä¸ºç›¸åº”çš„æœåŠ¡é‡æ–°åŠ è½½å‘½ä»¤ã€‚

1. ä¿å­˜æ–‡ä»¶å¹¶é€€å‡ºã€‚ç°åœ¨ï¼ŒCertbot å°†ä¼šæŒ‰ç…§ä½ è®¾ç½®çš„æ—¶é—´è‡ªåŠ¨ç»­æœŸè¯ä¹¦ã€‚

## **1.4 æ£€æŸ¥è¯ä¹¦ç»­æœŸçŠ¶æ€**

1. ä½ å¯ä»¥éšæ—¶è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥è¯ä¹¦çš„ç»­æœŸçŠ¶æ€ï¼š

`certbot renew --dry-run`

- -dry-run å‚æ•°è¡¨ç¤ºè¿›è¡Œä¸€æ¬¡æ¨¡æ‹Ÿç»­æœŸï¼Œä¸ä¼šå®é™…æ›´æ–°è¯ä¹¦ï¼Œä½†ä¼šæ˜¾ç¤ºå¦‚æœè¿›è¡Œç»­æœŸä¼šå‘ç”Ÿçš„æƒ…å†µã€‚

1. è¯¥å‘½ä»¤ä¼šè¾“å‡ºè¯ä¹¦çš„åˆ°æœŸæ—¶é—´ã€æ˜¯å¦éœ€è¦ç»­æœŸç­‰ä¿¡æ¯ã€‚å¦‚æœæ˜¾ç¤ºâ€œYour existing certificate has not expired yet and there is nothing to do.â€ï¼Œåˆ™è¡¨ç¤ºè¯ä¹¦ç›®å‰ä¸éœ€è¦ç»­æœŸã€‚

> âœ… é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ Certbot è½»æ¾å®ç°è¯ä¹¦çš„è‡ªåŠ¨ç»­æœŸï¼Œç¡®ä¿ä½ çš„ç½‘ç«™å§‹ç»ˆä½¿ç”¨æœ‰æ•ˆçš„ SSL/TLS è¯ä¹¦ï¼Œæé«˜ç½‘ç«™çš„å®‰å…¨æ€§å’Œå¯ä¿¡åº¦ã€‚

# äºŒã€é€šé…ç¬¦åŸŸåçš„å®‰è£…

> ğŸš« ç„¶è€Œï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹é€šé…ç¬¦åŸŸåï¼ˆä¹Ÿå°±æ˜¯`*.example.com`æ ¼å¼çš„åŸŸåï¼‰è¿›è¡Œè¯ä¹¦ç»­æœŸï¼Œè¿™ä¸ªæ—¶å€™ä¸Šé¢çš„æ­¥éª¤å°±ä¸å¤Ÿç”¨äº†ã€‚

ä¸ç®¡æ˜¯ç”³è¯·è¿˜æ˜¯ç»­æœŸï¼Œåªè¦æ˜¯é€šé…ç¬¦è¯ä¹¦ï¼Œåªèƒ½é‡‡ç”¨ dns-01 çš„æ–¹å¼æ ¡éªŒç”³è¯·è€…çš„åŸŸåï¼Œä¹Ÿå°±æ˜¯è¯´ certbot æ“ä½œè€…å¿…é¡»æ‰‹åŠ¨æ·»åŠ  DNS TXT è®°å½•ã€‚

## 2.0 å‡†å¤‡å·¥ä½œ

è¿™æ—¶å€™éœ€è¦ç”¨åˆ°ä¸€ä¸ªè„šæœ¬ï¼šÂ [https://github.com/yangrongzhou/certbot-letencrypt-wildcardcertificates-alydns-au](https://github.com/yangrongzhou/certbot-letencrypt-wildcardcertificates-alydns-au)

åªéœ€è¦å°†è„šæœ¬ä¸‹è½½åˆ°æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”é…ç½®å¥½å¯¹åº”çš„ æœåŠ¡ Open API å¯†é’¥å³å¯

å‚æ•°è¯´æ˜

- certonlyï¼šè¡¨ç¤ºé‡‡ç”¨éªŒè¯æ¨¡å¼ï¼Œåªä¼šè·å–è¯ä¹¦ï¼Œä¸ä¼šä¸º web æœåŠ¡å™¨é…ç½®è¯ä¹¦
- -manualï¼šè¡¨ç¤ºæ’ä»¶
- -preferred-challenges dnsï¼šè¡¨ç¤ºé‡‡ç”¨ DNS éªŒè¯ç”³è¯·è€…åˆæ³•æ€§ï¼ˆæ˜¯ä¸æ˜¯åŸŸåçš„ç®¡ç†è€…ï¼‰
- -dry-runï¼šåœ¨å®é™…ç”³è¯·/æ›´æ–°è¯ä¹¦å‰è¿›è¡Œæµ‹è¯•ï¼Œå¼ºçƒˆæ¨è
- dï¼šè¡¨ç¤ºéœ€è¦ä¸ºé‚£ä¸ªåŸŸåç”³è¯·è¯ä¹¦ï¼Œå¯ä»¥æœ‰å¤šä¸ªã€‚
- -manual-auth-hookï¼šåœ¨æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™è°ƒç”¨ä¸€ä¸ª hook æ–‡ä»¶
- -manual-cleanup-hookï¼šæ¸…é™¤ DNS æ·»åŠ çš„è®°å½•

| å‚æ•°                  | å‚æ•°ä½¿ç”¨è¯´æ˜                                                  |
| --------------------- | ------------------------------------------------------------- |
| --manual-auth-hook    | åœ¨æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™è°ƒç”¨çš„ hook è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºé‰´æƒä½¿ç”¨            |
| --manual-cleanup-hook | åœ¨æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™è°ƒç”¨çš„ hook è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºæ¸…ç† DNS TXT Record |

## **2.1 å®‰è£… Certbot**

åŒ 1.1 æ­¥éª¤ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†

## **2.2 è·å–è¯ä¹¦**

```shell
certbot certonly -d *.kuangyichen.com --manual --preferred-challenges dns --dry-run --manual-auth-hook "/data/server/certbot-letencrypt-wildcardcertificates-alydns-au/au.sh python txy add" --manual-cleanup-hook "/data/server/certbot-letencrypt-wildcardcertificates-alydns-au/au.sh python txy clean" --logs-dir logs --config-dir config --work-dir work
```

## **2.3 æ›´æ–°è¯ä¹¦**

```shell
certbot renew  --manual --preferred-challenges dns --manual-auth-hook "/data/server/certbot-letencrypt-wildcardcertificates-alydns-au/au.sh python txy add" --manual-cleanup-hook "/data/server/certbot-letencrypt-wildcardcertificates-alydns-au/au.sh python txy clean" --logs-dir logs --config-dir config --work-dir work --dry-run
```

# ä¸‰ã€å…¶ä»–

## **3.1 å¦‚ä½•æŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Ÿ**

**å‘½ä»¤è¡Œæ–¹å¼**

```shell
openssl x509 -in /root/config/live/example.com/fullchain.pem -noout -enddate
```

ä¼šæ‰“å°å‡ºè¯ä¹¦åˆ°æœŸæ—¶é—´ï¼Œå¦‚ä¸‹æ‰€ç¤º

```shell
notAfter=Mar 20 07:20:27 2025 GMT
```

**Web é¡µé¢ç›´æ¥æŸ¥çœ‹**

æ‰“å¼€å¯¹åº”ç½‘ç«™ï¼Œç‚¹å‡»æµè§ˆå™¨é“¾æ¥è¾“å…¥æ æ—çš„é”å›¾æ ·ï¼Œç‚¹å‡»è¿æ¥å®‰å…¨ï¼Œç‚¹å‡»è¯ä¹¦å›¾æ ·ï¼Œå³å¯æ‰“å¼€è¯ä¹¦æŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://image.kuangyichen.com/image/my_note/202412201832317.png)

![](https://image.kuangyichen.com/image/my_note/202412201832278.png)

![](https://image.kuangyichen.com/image/my_note/202412201831279.png)

# å‚è€ƒ

[https://certbot.eff.org/](https://certbot.eff.org/)

[https://eff-certbot.readthedocs.io/](https://eff-certbot.readthedocs.io/)

[https://certbot.eff.org/glossary](https://certbot.eff.org/glossary)
